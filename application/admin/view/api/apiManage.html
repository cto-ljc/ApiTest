
<style>
.app{  }
.right{ float: right; margin-left: 10px; }
.layui-tab{ position: relative; }
.nav_manage{ position: absolute; top: 1px; right: 2px; }
.api-nav{ background-color: #000; }
.layui-table th.handle,.handle{width:100px; float:right; text-align: right;}
.layui-tab-content .layui-tab-item .nav{    height: 30px;  line-height: 30px;  padding-right:5px;  }
</style>

<div class="layui-tab-content">
    <xblock>
        <!-- <button class="layui-btn layui-btn-danger" onclick="delAll()"><i class="layui-icon">&#xe640;</i>批量删除</button> -->
        <form class="layui-form " action="">
            <div class="layui-inline">
                <select name="app" lay-filter="app">
                    <option value="">项目列表</option>                       
                    {volist name="app_list" id="vo"}
                        {if condition="$vo.id eq $app_id"}
                            <option value="{$vo.id}" selected>{$vo.name}</option>
                        {else /}
                            <option value="{$vo.id}">{$vo.name}</option>
                        {/if}                        
                    {/volist}                    
                </select>
            </div>
            <div class="layui-inline">
                <div class="layui-btn" onclick="navList('分类管理','{:url('App/appList',array('app_id' => $app_id))}','800','600')">项目管理</div>
            </div>
        </form>
        
    </xblock>
    {notempty name="api_data"}
    <div class="layui-tab layui-tab-card" style="height: auto;" lay-filter="api_nav">
        <ul class="layui-tab-title">            
            {volist name="api_data" id="vo" key='key'}
                {if condition="$key eq 1"}
                    <li class="layui-this" lay-id="{$vo.id}">{$vo.name}</li> 
                {else /}
                    <li lay-id="{$vo.id}">{$vo.name}</li> 
                {/if}                          
            {/volist}     
            
        </ul>
        {if condition="$app_id neq 0"}
            <button class="layui-btn right nav_manage" onclick="navList('分类管理','{:url('ApiNav/navList',array('app_id' => $app_id))}','800','600')"><i class="layui-icon">&#xe608;</i> 分类管理</button>
        {/if} 
        <div class="layui-tab-content" style="padding: 10px;">
            {volist name="api_data" id="vo" key='key'}
                <div class="layui-tab-item {if condition='$key eq 1'}layui-show{/if}">                    
                    <div class="nav">
                        <button class="layui-btn layui-btn-mini" onclick="add_api('添加接口','{:url(\'addApi\',array(\'nav_id\' => $vo.id) )}','900','500')">添加接口</button>
                        <span style='float:right;'>{$vo.name} 接口数量：<span class='right'>{$vo.api_count}</span></span>
                    </div>
                    <table class="layui-table" lay-even lay-skin="nob">
                        <thead>
                            <tr>
                                <th>名称</th>                               
                                <th>排序</th>
                                <th class="handle">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        {volist name="vo['api_list']" id="api"}
                            <tr>
                                <td>{$api.name}</td>
                                <td>{$api.sort}</td>
                                <td class="handle">
                                    <a title="编辑" href="javascript:;" onclick="edit_api('编辑','{:url('editApi',array(\'api_id\' => $api.id))}','4','900','500')"
                                    class="ml-5" style="text-decoration:none">
                                        <i class="layui-icon">&#xe642;</i>
                                    </a>
                                    <a title="删除" href="javascript:;" onclick="del_api(this,{$api.id})" 
                                    style="text-decoration:none">
                                        <i class="layui-icon">&#xe640;</i>
                                    </a>
                                </td>
                            </tr>
                        {/volist}
                        </tbody>
                    </table>
                </div>     
            {/volist}              
        </div>
    </div>   
    {/notempty}
    <div id="page"></div>
</div>

<script>

layui.use(['form','laydate','element','laypage','layer'], function(){
    // $ = layui.jquery;//jquery
    // laydate = layui.laydate;//日期插件
    // lement = layui.element();//面包导航
    // laypage = layui.laypage;//分页
    // layer = layui.layer;//弹出层
    var form = layui.form();
    var element = layui.element();

    //以上模块根据需要引入
    form.on('select(app)', function(data){        
        var app_id = data.value;       
        var url = "{:url('','','')}"+'/app_id/'+app_id;        
        window.location.href = url;
    });

    var layid = location.hash.replace(/^#api_nav=/, '');
    element.tabChange('api_nav', layid); //假设当前地址为：http://a.com#api_nav=222，那么选项卡会自动切换到“发送消息”这一项

    element.on('tab(api_nav)', function(elem){
        var layid = this.getAttribute('lay-id');

        location.hash = 'api_nav='+ layid;
    });
});

/*添加*/
function navList(title,url,w,h){
    layer.open({
        type: 2,
        area: [w+'px', h +'px'],
        fix: false, //不固定
        maxmin: true,
        shadeClose: true,
        shade:0.4,
        title: title,
        content: url,
        end: function(){
            location.reload();
        }
    });        
}

/*添加*/
function add_api(title,url,w,h){
    layer.open({
        type: 2,
        area: [w+'px', h +'px'],
        fix: false, //不固定
        maxmin: true,
        shadeClose: true,
        shade:0.4,
        title: title,
        content: url,
        end: function(){
            location.reload();
        }
    });        
}

/*编辑*/ 
function edit_api (title,url,id,w,h) {
    layer.open({
        type: 2,
        area: [w+'px', h +'px'],
        fix: false, //不固定
        maxmin: true,
        shadeClose: true,
        shade:0.4,
        title: title,
        content: url,
        end: function(){
            location.reload();
        }
    });     
}

/*删除api*/
function del_api(obj,api_id){
    var url = "{:url('delApi')}";
    var data = {};
    data['api_id'] = api_id;
    post(data,url,function(ret){
        var msg = ret.msg;
        if(ret.success == true){
            var tr = $(obj).parents('tr');
            $(tr).remove();
        }
        layer.msg(msg);
    });
}

/*删除*/
function del(obj,id){
    layer.confirm('确认要删除吗？',function(index){
        var url = "{:url('delNav')}";
        var data = {};
        data['app_id'] = id;
        post(data,url,function(ret){    //发异步删除数据
            var msg = ret.msg;
            if(ret.success == true){
                $(obj).parents("tr").remove();
            }                
            layer.msg(msg,{icon:1,time:1000});
        });
        
    });
}
</script>