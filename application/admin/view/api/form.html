<style>

#param_table tbody th{     padding: 7px 10px; }
#param_table tr th.handle{ width: 80px; }
#param_table tbody tr th .input{     width: 80px; display: block; border: none; background-color: transparent; height: auto; padding: 0; padding: 5px; border-radius: 2px;}
#param_table tbody tr:not(.del_param) th .input:hover,#param_table tbody tr:not(.del_param) th .input:focus{ background-color: #efefef;}

/*修改状态下的行*/
#param_table tbody tr.update_param{}

/*删除状态下的行*/
#param_table tbody tr.del_param{ background-color: transparent; }
#param_table tbody tr.del_param .input,#param_table tbody tr.del_param select{ color: #dadada; }

/*加密下拉菜单*/
#param_table tbody tr th select{ border: 1px solid #d6d6d6;  padding: 5px;  border-radius: 2px;}
/*input强调色 提示有问题的输入框*/
#param_table tbody tr th .input.warn{ border: 1px solid rgba(165, 0, 0, 0.46); }

/*保存按钮*/
.save{ position: absolute; right: 20px; top: 26px; z-index: 100;}
</style>
<div class='layui-tab-content'>
	<div class="layui-tab layui-tab-card" style="height: auto;" lay-filter="demo">
		<div class="save layui-btn layui-btn-sm layui-btn-primary" @click="save()">保存</div>
        <ul class="layui-tab-title"> 
                <li class="layui-this">接口信息</li> 
                <li>参数</li> 
        </ul>
        <div class="layui-tab-content" style="padding: 10px;">
            <div class="layui-tab-item layui-show">
               	<div class="layui-field-box">
					<form class="layui-form layui-form-pane1" action="">
						<input type="hidden" name="api_id" :value="api.id">
						<div class="layui-form-item">
							<label class="layui-form-label">名称:</label>
							<div class="layui-input-block">
								<input type="text" name="name" lay-verify='required' v-model="api.name" required placeholder="" autocomplete="off" class="layui-input">
								<span class="remark"></span>
							</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">路径:</label>
							<div class="layui-input-block">
								<input type="text" name="path" lay-verify='required' v-model="api.path" required placeholder="" autocomplete="off" class="layui-input">
								<span class="remark"></span>
							</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">排序:</label>
							<div class="layui-input-block">
								<input type="text" name="sort" v-model="api.sort" required placeholder="" autocomplete="off" class="layui-input">
								<span class="remark"></span>
							</div>
						</div>
					</form>
				</div>
            </div>     
            <div class="layui-tab-item">
               	<table class="layui-table" id='param_table' lay-even lay-skin="nob">
                    <thead>
                        <tr>
                            <th>名称</th>   
                            <th>备注</th>
                            <th>页面缓存</th>         
                            <th>加密</th>             
                            <th>默认值</th>        
                            <th>排序</th>
                            <th class="handle" style="padding-left:10px;">
                            	<button class="layui-btn layui-btn-xs" @click="add_param()">添加</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>     
                		<tr class='param' v-for="(item,index) in param" v-if="!item.del">
                            <th><input class="input" v-model='item.name' placeholder='参数名' value=""></th>   
                            <th><input class="input" v-model='item.remark' placeholder='备注' value=""></th>
                            <th>
                            	<select v-model='item.storage'>	                            		
                        			<option value="0" selected>不缓存</option>
                            		<option value="1" >缓存</option>
                            	</select>
                            </th>         
                            <th>
                            	<select v-model='item.encrypt' >
                            		<option :value="value" v-for="(option,value) in encrypt_array" >{{option}}</option>                            		
                            	</select>
                            </th>             
                            <th><input class="input" v-model='item.value' placeholder='无' value=""></th>        
                            <th><input class="input" v-model='item.sort' placeholder='排序' value=""></th>
                            <th class="handle">
                            	<!-- <button class="layui-btn layui-btn-mini save" >保存</button> -->
                            	<button class="layui-btn layui-btn-xs layui-btn-danger" @click="del_param(index)">删除</button>
                            </th>
                        </tr>
                    </tbody>
                </table>
            </div>     
        </div>
    </div>   
  	
</div>
<script>
var vm = new Vue({
	el:'.layui-tab-content',
	data:{
		encrypt_array:JSON.parse('{:json_encode($encrypt_array)}'),
		api:JSON.parse('{:json_encode(@$api)}'),
		param:JSON.parse('{:json_encode(@$param)}'),		
	},
	mounted:function(){
		console.log(this.param);
	},
	methods:{
		//添加参数
		add_param:function(){
			var param = {
				sort:100,
				storage:1,
				encrypt:'normal'
			};
			this.param.push(param);
		},
		//删除参数
		del_param:function(index){
			var param = this.param[index];
			if(param.id){
				param.del = true;
				this.param.splice(index,1,param);
			}else{
				this.param.splice(index,1);
			}			
		},
		//参数完整性检测
		param_check:function(){
			for(var i in this.param){
				var param = this.param[i];
				if(param.name == ''){
					layer.msg('参数名称不能为空');
					return false;
				}
			}
			return true;
		},
		//保存
		save:function(){			
			var that = this;
			if(this.api.name == ''){
				layer.msg("请填写api名称");
				return;
			}
			if(this.api.path == ''){
				layer.msg("请填写api路径");
				return;
			}

			if(!this.param_check()){
				return;
			}

			var data = {};
			data.api = this.api;	
			data.param = this.param;		

			var url = "{:url('',input())}";
			$.ajax({
				type:'post',
				dataType:'json',
				url:url,
				data:data,
				success:function(ret){
					console.log(ret);
					parent.layer.msg(ret.msg);
					if(ret.success != true){
						return ;
					}
					if(ret.data.action == 'add'){
						parent.vm.api_array.push(ret.data.api);						
					}else{												
						for(var i in parent.vm.api_array){
							if(parent.vm.api_array[i].id == that.api.id){
								parent.vm.api_array.splice(i,1,that.api);								
							}
						}
					}			

					var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
					parent.layer.close(index); //再执行关闭   		
				},
				error:function(){
					layer.msg('网络错误');
				},
				beforeSend:function(){
                    layer.load();
                },
                complete:function(){
                    layer.closeAll('loading');
                }
			});
		}
	}
});

layui.use(['form','element'], function(){	

  
});

</script>